---
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SEO from '../components/SEO.astro';
import SchemaMarkup from '../components/SchemaMarkup.astro';
import Analytics from '../components/Analytics.astro';
import Intercom from '../components/Intercom.astro';
import StickyCTA from '../components/ui/StickyCTA';

interface Props {
  title: string;
  description: string;
  image?: string;
  article?: boolean;
  publishDate?: string;
  canonicalURL?: string;
  schemaType?: 'home' | 'about' | 'services' | 'contact' | 'blog-post' | 'resource-hub';
  schemaPost?: {
    title: string;
    description: string;
    publishDate: string;
    image?: string;
    url: string;
  };
  schemaFaqs?: Array<{ question: string; answer: string }>;
}

const {
  title,
  description,
  image,
  article = false,
  publishDate,
  canonicalURL,
  schemaType,
  schemaPost,
  schemaFaqs,
} = Astro.props;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0A0A0F" />
    <link rel="icon" type="image/png" href="/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/logo-64.png" sizes="64x64" />
    <link rel="apple-touch-icon" href="/logo.png" />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    <link rel="preconnect" href="https://widget.intercom.io" crossorigin />
    <link rel="dns-prefetch" href="https://api-iam.intercom.io" />

    <SEO
      title={title}
      description={description}
      image={image}
      article={article}
      publishDate={publishDate}
      canonicalURL={canonicalURL}
    />

    {schemaType && (
      <SchemaMarkup
        type={schemaType}
        post={schemaPost}
        faqs={schemaFaqs}
      />
    )}

    <ClientRouter />
    <link rel="alternate" type="application/rss+xml" title="Lumina ERP Blog" href="/rss.xml" />
  </head>
  <body class="min-h-dvh flex flex-col bg-bg-base text-text-primary font-sans antialiased">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TGNXHWTC" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <a href="#main-content" class="skip-to-content">Skip to content</a>
    <div class="scroll-progress" aria-hidden="true"></div>
    <Header />
    <main id="main-content" class="flex-1 pt-16">
      <slot />
    </main>
    <Footer />
    <StickyCTA client:idle />
    <Analytics />
    <Intercom />

    <script is:inline>
      (function() {
        function initScrollReveal() {
          var selectors = '.scroll-reveal, .scroll-reveal-left, .scroll-reveal-scale';
          var elements = document.querySelectorAll(selectors);

          if (!elements.length) return;

          var prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

          if (prefersReduced) {
            elements.forEach(function(el) { el.classList.add('visible'); });
            return;
          }

          var observer = new IntersectionObserver(
            function(entries) {
              entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                  var el = entry.target;
                  var delay = el.style.animationDelay || '0ms';
                  var ms = parseInt(delay, 10) || 0;
                  setTimeout(function() { el.classList.add('visible'); }, ms);
                  observer.unobserve(el);
                }
              });
            },
            { threshold: 0.08, rootMargin: '0px 0px -30px 0px' }
          );

          elements.forEach(function(el) {
            if (!el.classList.contains('visible')) {
              observer.observe(el);
            }
          });

          // Stagger groups: when the parent enters view, reveal children sequentially
          var staggerGroups = document.querySelectorAll('[data-stagger-group]');
          if (!staggerGroups.length) return;

          var staggerDelay = 80; // ms between each child

          var groupObserver = new IntersectionObserver(
            function(entries) {
              entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                  var children = entry.target.querySelectorAll('.stagger-item');
                  children.forEach(function(child, i) {
                    setTimeout(function() { child.classList.add('visible'); }, i * staggerDelay);
                  });
                  groupObserver.unobserve(entry.target);
                }
              });
            },
            { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
          );

          staggerGroups.forEach(function(group) {
            groupObserver.observe(group);
          });
        }

        // Primary: Astro view transitions event
        document.addEventListener('astro:page-load', initScrollReveal);
        // Fallback: standard DOM ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initScrollReveal);
        } else {
          initScrollReveal();
        }
      })();
    </script>
  </body>
</html>
