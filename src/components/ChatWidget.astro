---
// Custom Tawk.to launcher with frosted glass aesthetic
// Matches site design tokens and provides smooth animations
---

<!-- Custom Chat Launcher Button -->
<button
  id="chat-launcher"
  class="chat-launcher"
  aria-label="Open live chat"
  type="button"
>
  <svg id="chat-icon" class="chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
  </svg>
  <svg id="close-icon" class="chat-icon chat-icon-hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line>
    <line x1="6" y1="6" x2="18" y2="18"></line>
  </svg>
  <span id="chat-badge" class="chat-badge chat-badge-hidden">0</span>
</button>

<style>
  .chat-launcher {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: var(--z-modal);
    width: 60px;
    height: 60px;
    border-radius: var(--radius-full);
    border: 1px solid var(--border);
    background: rgba(18, 18, 26, 0.8);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    color: var(--accent-primary);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-out);
    box-shadow:
      var(--shadow-md),
      var(--shadow-glow);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    outline: none;
  }

  .chat-launcher:hover {
    transform: translateY(-2px);
    box-shadow:
      var(--shadow-lg),
      var(--shadow-glow-lg);
    border-color: var(--accent-primary);
    background: rgba(18, 18, 26, 0.9);
  }

  .chat-launcher:active {
    transform: translateY(0);
  }

  .chat-launcher:focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
  }

  .chat-icon {
    width: 28px;
    height: 28px;
    transition:
      opacity var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
    position: absolute;
  }

  .chat-icon-hidden {
    opacity: 0;
    transform: rotate(90deg) scale(0.8);
    pointer-events: none;
  }

  .chat-launcher.widget-open #chat-icon {
    opacity: 0;
    transform: rotate(-90deg) scale(0.8);
  }

  .chat-launcher.widget-open #close-icon {
    opacity: 1;
    transform: rotate(0) scale(1);
  }

  .chat-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    border-radius: var(--radius-full);
    background: var(--accent-error);
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(248, 113, 113, 0.4);
    transition:
      opacity var(--duration-fast) var(--ease-out),
      transform var(--duration-fast) var(--ease-out);
  }

  .chat-badge-hidden {
    opacity: 0;
    transform: scale(0);
    pointer-events: none;
  }

  /* Animation on mount */
  @keyframes slideInBounce {
    0% {
      opacity: 0;
      transform: translateY(100px) scale(0.8);
    }
    60% {
      opacity: 1;
      transform: translateY(-8px) scale(1.05);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .chat-launcher {
    animation: slideInBounce 0.6s var(--ease-out) 0.5s both;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .chat-launcher {
      bottom: 1rem;
      right: 1rem;
      width: 56px;
      height: 56px;
    }

    .chat-icon {
      width: 24px;
      height: 24px;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .chat-launcher {
      animation: none;
      opacity: 1;
      transform: none;
    }

    .chat-launcher:hover {
      transform: none;
    }

    .chat-icon,
    .chat-badge {
      transition: none;
    }
  }
</style>

<script>
  // Initialize Tawk.to API integration
  declare global {
    interface Window {
      Tawk_API?: {
        onLoad?: () => void;
        onChatMaximized?: () => void;
        onChatMinimized?: () => void;
        onUnreadCountChanged?: (count: number) => void;
        maximize?: () => void;
        minimize?: () => void;
        toggle?: () => void;
        hideWidget?: () => void;
        showWidget?: () => void;
        isChatMaximized?: () => boolean;
      };
      Tawk_LoadStart?: Date;
    }
  }

  function initChatWidget() {
    const launcher = document.getElementById('chat-launcher');
    const badge = document.getElementById('chat-badge');

    if (!launcher || !badge) return;

    let isWidgetOpen = false;

    // Initialize Tawk_API
    window.Tawk_API = window.Tawk_API || {};

    // Hide default widget on load
    window.Tawk_API.onLoad = function() {
      window.Tawk_API?.hideWidget?.();
    };

    // Track chat state
    window.Tawk_API.onChatMaximized = function() {
      isWidgetOpen = true;
      launcher.classList.add('widget-open');
    };

    window.Tawk_API.onChatMinimized = function() {
      isWidgetOpen = false;
      launcher.classList.remove('widget-open');
    };

    // Update unread message badge
    window.Tawk_API.onUnreadCountChanged = function(count: number) {
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count.toString();
        badge.classList.remove('chat-badge-hidden');
      } else {
        badge.classList.add('chat-badge-hidden');
      }
    };

    // Handle launcher click
    launcher.addEventListener('click', () => {
      if (window.Tawk_API?.toggle) {
        window.Tawk_API.toggle();
        // Update state manually if widget doesn't trigger events
        isWidgetOpen = !isWidgetOpen;
        launcher.classList.toggle('widget-open', isWidgetOpen);
      }
    });

    // Keyboard accessibility
    launcher.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        launcher.click();
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChatWidget);
  } else {
    initChatWidget();
  }
</script>
