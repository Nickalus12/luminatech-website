---
const currentPath = Astro.url.pathname;
const isContactPage = currentPath === '/contact' || currentPath === '/contact/';

const navLinks = [
  { label: 'Home', href: '/' },
  { label: 'Services', href: '/services' },
  { label: 'Resources', href: '/resources' },
  { label: 'Case Studies', href: '/case-studies' },
  { label: 'About', href: '/about' },
  { label: 'Blog', href: '/blog' },
];

function isActive(href: string): boolean {
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
}
---

<header
  id="site-header"
  class="fixed top-0 left-0 right-0 z-50 h-16 md:h-16 transition-transform duration-normal ease-out"
>
  <div class="absolute inset-0 bg-bg-base/85 backdrop-blur-xl border-b border-border/50"></div>
  <nav class="relative w-full max-w-7xl mx-auto px-4 md:px-6 h-full flex items-center justify-between">
    <a href="/" class="flex items-center gap-2.5 text-text-primary no-underline shrink-0">
      <svg class="w-7 h-7 shrink-0" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="header-brand" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#3B82F6"/>
            <stop offset="100%" stop-color="#8B5CF6"/>
          </linearGradient>
          <linearGradient id="header-glow" x1="50%" y1="0%" x2="50%" y2="100%">
            <stop offset="0%" stop-color="#93C5FD"/>
            <stop offset="100%" stop-color="#3B82F6"/>
          </linearGradient>
        </defs>
        <path d="M8 4h5v19h11v5H8V4z" fill="url(#header-brand)"/>
        <path d="M22 4l1.5 3.5L27 9l-3.5 1.5L22 14l-1.5-3.5L17 9l3.5-1.5z" fill="url(#header-glow)" opacity="0.9"/>
      </svg>
      <span class="text-xl font-bold tracking-tight">LUMINA<span class="text-accent-primary"> ERP</span></span>
    </a>

    <!-- Desktop nav -->
    <ul class="hidden md:flex items-center gap-1 list-none m-0 p-0">
      {navLinks.map(({ label, href }) => (
        <li>
          <a
            href={href}
            class:list={[
              'relative px-3 py-2 text-[15px] font-medium rounded-md transition-all duration-fast no-underline',
              isActive(href)
                ? 'text-accent-primary bg-accent-primary/[0.08]'
                : 'text-text-secondary hover:text-text-primary hover:bg-white/[0.04]',
            ]}
            aria-current={isActive(href) ? 'page' : undefined}
          >
            {label}
            {isActive(href) && (
              <span class="absolute bottom-0.5 left-3 right-3 h-0.5 bg-accent-primary rounded-full" />
            )}
          </a>
        </li>
      ))}
    </ul>

    {!isContactPage && (
      <div class="hidden md:block">
        <a
          href="/contact"
          class="inline-flex items-center gap-2 px-5 py-2 bg-accent-primary text-white text-sm font-semibold rounded-lg hover:bg-accent-primary-hover hover:shadow-[0_0_16px_rgba(59,130,246,0.35)] hover:scale-[1.02] active:scale-[0.98] transition-all duration-fast no-underline"
        >
          Free Consultation
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M5 12h14" /><path d="m12 5 7 7-7 7" />
          </svg>
        </a>
      </div>
    )}

    <!-- Mobile hamburger -->
    <button
      id="menu-toggle"
      class="md:hidden relative w-10 h-10 flex items-center justify-center text-text-secondary hover:text-text-primary transition-colors rounded-md"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <svg id="menu-icon-open" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <line x1="4" x2="20" y1="6" y2="6" />
        <line x1="4" x2="20" y1="12" y2="12" />
        <line x1="4" x2="20" y1="18" y2="18" />
      </svg>
      <svg id="menu-icon-close" class="hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M18 6 6 18" />
        <path d="m6 6 12 12" />
      </svg>
    </button>
  </nav>
</header>

<!-- Mobile menu overlay -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-40 bg-bg-base/95 backdrop-blur-xl hidden flex-col pt-20 pb-8 px-6"
  aria-hidden="true"
>
  <nav class="flex flex-col gap-2">
    {navLinks.map(({ label, href }) => (
      <a
        href={href}
        class:list={[
          'px-4 py-3 text-lg font-medium rounded-lg transition-all duration-fast no-underline',
          isActive(href)
            ? 'text-accent-primary bg-accent-primary/10 border-l-2 border-accent-primary'
            : 'text-text-secondary hover:text-text-primary hover:bg-bg-surface-2 border-l-2 border-transparent',
        ]}
        aria-current={isActive(href) ? 'page' : undefined}
      >
        {label}
      </a>
    ))}
  </nav>
  {!isContactPage && (
    <div class="mt-auto pt-6">
      <a
        href="/contact"
        class="flex items-center justify-center gap-2 w-full px-6 py-3.5 bg-accent-primary text-white text-base font-semibold rounded-lg hover:bg-accent-primary-hover hover:shadow-[0_0_20px_rgba(59,130,246,0.35)] transition-all duration-fast no-underline"
      >
        Free Consultation
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M5 12h14" /><path d="m12 5 7 7-7 7" />
        </svg>
      </a>
    </div>
  )}
</div>

<script is:inline>
  (function() {
    var headerAbort = null;

    function initHeader() {
      // Clean up previous listeners
      if (headerAbort) headerAbort.abort();
      headerAbort = new AbortController();
      var signal = headerAbort.signal;

      var header = document.getElementById('site-header');
      var toggle = document.getElementById('menu-toggle');
      var menu = document.getElementById('mobile-menu');
      var iconOpen = document.getElementById('menu-icon-open');
      var iconClose = document.getElementById('menu-icon-close');

      if (!header || !toggle || !menu || !iconOpen || !iconClose) return;

      // Reset state on navigation (close menu, show header)
      menu.classList.add('hidden');
      menu.classList.remove('flex');
      menu.setAttribute('aria-hidden', 'true');
      toggle.setAttribute('aria-expanded', 'false');
      iconClose.classList.add('hidden');
      iconOpen.classList.remove('hidden');
      document.body.style.overflow = '';
      header.style.transform = 'translateY(0)';

      // Auto-hide header on scroll
      var lastScrollY = 0;
      var ticking = false;

      function updateHeader() {
        var scrollY = window.scrollY;
        var isMenuOpen = menu.classList.contains('flex');

        if (!isMenuOpen) {
          if (scrollY > lastScrollY && scrollY > 80) {
            header.style.transform = 'translateY(-100%)';
          } else {
            header.style.transform = 'translateY(0)';
          }
        }

        lastScrollY = scrollY;
        ticking = false;
      }

      window.addEventListener('scroll', function() {
        if (!ticking) {
          requestAnimationFrame(updateHeader);
          ticking = true;
        }
      }, { passive: true, signal: signal });

      // Mobile menu toggle
      function openMenu() {
        menu.classList.remove('hidden');
        menu.classList.add('flex');
        menu.setAttribute('aria-hidden', 'false');
        toggle.setAttribute('aria-expanded', 'true');
        iconOpen.classList.add('hidden');
        iconClose.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        var firstLink = menu.querySelector('a');
        if (firstLink) firstLink.focus();
      }

      function closeMenu() {
        menu.classList.add('hidden');
        menu.classList.remove('flex');
        menu.setAttribute('aria-hidden', 'true');
        toggle.setAttribute('aria-expanded', 'false');
        iconClose.classList.add('hidden');
        iconOpen.classList.remove('hidden');
        document.body.style.overflow = '';
      }

      toggle.addEventListener('click', function() {
        var isOpen = menu.classList.contains('flex');
        if (isOpen) {
          closeMenu();
        } else {
          openMenu();
        }
      }, { signal: signal });

      // Close on escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menu.classList.contains('flex')) {
          closeMenu();
          toggle.focus();
        }
      }, { signal: signal });

      // Focus trap within mobile menu
      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Tab' || !menu.classList.contains('flex')) return;
        var focusable = [toggle].concat(Array.from(menu.querySelectorAll('a')));
        var first = focusable[0];
        var last = focusable[focusable.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }, { signal: signal });

      // Close on link click
      menu.querySelectorAll('a').forEach(function(link) {
        link.addEventListener('click', closeMenu, { signal: signal });
      });
    }

    // Primary: Astro view transitions event
    document.addEventListener('astro:page-load', initHeader);
    // Fallback: standard DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeader);
    } else {
      initHeader();
    }
  })();
</script>
